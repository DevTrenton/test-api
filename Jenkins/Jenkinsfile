def remote = [:]
remote.name = 'devadmin'
remote.host = '192.168.100.123'
remote.allowAnyHosts = true

pipeline {
    agent any

    stages {
        stage('Connect to Server') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'devadmin', passwordVariable: 'password', usernameVariable: 'username')]) {
                        sh """
                            /usr/bin/expect -c '
                            spawn ssh -o StrictHostKeyChecking=no ${env.username}@${remote.host}
                            expect "password:"
                            send "${env.password}\r"
                            interact
                            '
                        """
                    }
                }
            }
        }       
        stage('Deploy to Server'){
            steps{
                script{
                    sshagent(credentials:['gitToken']){
                        sh "sudo docker compose up -d"
                    }
                }
            }
        }
    }
}