def remote = [:]
remote.name = 'devadmin'
remote.host = '192.168.100.123'
remote.allowAnyHosts = true

pipeline {
    agent any
    stages {
        stage('Reading Environment Variables from .env file') {
            steps {
                script {
                    def props = readProperties file: '.env'

                    props.each {
                        env."${it.key}" = "${it.value}"
                    }
                }
            }
        }
        stage('Deploying Docker Compose to Staging Server') {
            steps {
                script {
                    remote.user = env.STAGING_USER
                    remote.password = env.STAGING_PASS
                }
                sshCommand (remote: remote, command: """
                    cd ~/projects/deploy-nib-online/admin-portal
                    echo '${env.STAGING_PASS}' | sudo -S docker compose down 
                    echo '${env.STAGING_PASS}' | sudo -S docker compose up -d 
                    """
                    )
                }
            }
        }
    }